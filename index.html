<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Photolog Generator</title>
    <!-- Meta tags for basic info -->
    <meta name="author" content="Photolog Tool by Tetra Tech" />
    <meta
      name="description"
      content="Upload images and metadata to generate formatted photo logs as Word documents."
    />
    <meta
      name="keywords"
      content="photolog, photo report, Word export, image metadata, Excel, project documentation"
    />

    <!-- Open Graph / Facebook -->
    <meta property="og:title" content="Photolog Generator" />
    <meta
      property="og:description"
      content="Easily generate Word-based photo reports from your project images and metadata."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://ttemiprod.com/PhotoLog" />
    <meta
      property="og:image"
      content="hhttps://ttemiprod.com/PhotoLog/photolog-preview.png"
    />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Photolog Generator" />
    <meta
      name="twitter:description"
      content="Generate photo documentation reports using images and Excel metadata."
    />
    <meta
      name="twitter:image"
      content="https://ttemiprod.com/PhotoLog/photolog-preview.png"
    />

    <!-- Favicon -->
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/evidenceprime/html-docx-js@master/dist/html-docx.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@9.3.0/dist/index.iife.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
      }

      .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 12px !important;
      }

      .report-table th,
      .report-table td {
        border: 1px solid #000;
        padding: 6px !important;
        vertical-align: top;
      }

      .photo-container {
        text-align: center;
      }

      .photo-container img {
        max-width: 100%;
        height: auto;
      }

      .floating-btn {
        position: fixed;
        top: 15px;
        right: 15px;
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 15px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 5px;
      }

      .floating-btn:hover {
        background: #218838;
      }
      .metadata-label {
        font-weight: bold;
        width: 30%;
      }

      .metadata-value {
        width: 40%;
      }

      .striped-row {
        background-color: #f2f2f2;
      }

      .photo-container {
        text-align: center;
        vertical-align: middle;
        padding: 5px;
      }

      .photo-container img {
        max-width: 100%;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div class="container my-4" id="input-form">
      <h1 class="text-center">Upload Images & Excel for Report</h1>
      <div class="mb-3">
        <label for="projectName" class="form-label">Project Name:</label>
        <input type="text" id="projectName" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="siteLocation" class="form-label">Site Location:</label>
        <input type="text" id="siteLocation" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="projectNumber" class="form-label">Project Number:</label>
        <input type="text" id="projectNumber" class="form-control" required />
      </div>

      <div class="mb-3">
        <label class="form-label">Choose Image Upload Method:</label>
        <div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="uploadType"
              id="zipOption"
              value="zip"
              checked
            />
            <label class="form-check-label" for="zipOption"
              >Upload ZIP file of images</label
            >
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="uploadType"
              id="multiOption"
              value="multi"
            />
            <label class="form-check-label" for="multiOption"
              >Select multiple images (multi-select)</label
            >
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="uploadType"
              id="folderOption"
              value="folder"
            />
            <label class="form-check-label" for="folderOption"
              >Select an image folder</label
            >
          </div>
        </div>
      </div>

      <div class="mb-3" id="zipUploadGroup">
        <label for="zipUpload" class="form-label">Upload ZIP File:</label>
        <input type="file" id="zipUpload" class="form-control" accept=".zip" />
      </div>

      <div class="mb-3 d-none" id="multiUploadGroup">
        <label for="multiUpload" class="form-label"
          >Select Multiple Images:</label
        >
        <input
          type="file"
          id="multiUpload"
          class="form-control"
          accept="image/*"
          multiple
        />
      </div>

      <div class="mb-3 d-none" id="folderUploadGroup">
        <label for="folderUpload" class="form-label"
          >Select Image Folder:</label
        >
        <input
          type="file"
          id="folderUpload"
          class="form-control"
          webkitdirectory
        />
      </div>

      <div class="mb-3">
        <label for="excelUpload" class="form-label"
          >Upload Excel Metadata File:</label
        >
        <input
          type="file"
          id="excelUpload"
          class="form-control"
          accept=".xlsx"
          required
        />
      </div>

      <button class="btn btn-success w-100" onclick="processFiles()">
        Generate Report
      </button>
    </div>

    <button
      id="export-word"
      class="floating-btn"
      onclick="chooseTemplate()"
      style="display: none"
    >
      Download as Word</button
    ><br />
    <button
      id="download-log"
      class="floating-btn btn-secondary"
      onclick="downloadLogFile()"
      style="
        display: none;
        right: 200px;
        background: #fcfcfc;
        color: #218838;
        border: 1px solid #218838;
      "
    >
      Download Log
    </button>

    <div id="report-content" class="container d-none"></div>

    <script>
      document.querySelectorAll('input[name="uploadType"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          document.getElementById("zipUploadGroup").classList.add("d-none");
          document.getElementById("multiUploadGroup").classList.add("d-none");
          document.getElementById("folderUploadGroup").classList.add("d-none");

          if (document.getElementById("zipOption").checked) {
            document
              .getElementById("zipUploadGroup")
              .classList.remove("d-none");
          } else if (document.getElementById("multiOption").checked) {
            document
              .getElementById("multiUploadGroup")
              .classList.remove("d-none");
          } else if (document.getElementById("folderOption").checked) {
            document
              .getElementById("folderUploadGroup")
              .classList.remove("d-none");
          }
        });
      });
    </script>

    <script>
      let unmatchedImages = [];
      let unmatchedExcelRows = [];

      async function processFiles() {
        unmatchedImages = [];
        unmatchedExcelRows = [];

        const projectName = document.getElementById("projectName").value;
        const siteLocation = document.getElementById("siteLocation").value;
        const projectNumber = document.getElementById("projectNumber").value;
        const excelFile = document.getElementById("excelUpload").files[0];
        const uploadType = document.querySelector(
          'input[name="uploadType"]:checked'
        )?.value;

        if (!excelFile) {
          Swal.fire("Error", "Please upload the Excel metadata file.", "error");
          return;
        }

        const excelData = await parseExcel(excelFile);
        const imageMap = new Map();

        let imageSources = [];

        if (uploadType === "zip") {
          const zipFile = document.getElementById("zipUpload").files[0];
          if (!zipFile) {
            Swal.fire("Error", "Please upload a ZIP file of images.", "error");
            return;
          }

          const zip = await JSZip.loadAsync(zipFile);
          const entries = Object.values(zip.files).filter((file) =>
            /\.(jpg|jpeg|png)$/i.test(file.name)
          );

          for (const entry of entries) {
            const blob = await entry.async("blob");
            const url = URL.createObjectURL(blob);
            const fileName = entry.name.split("/").pop();
            imageMap.set(fileName, url);
          }
        } else if (uploadType === "multi") {
          imageSources = [...document.getElementById("multiUpload").files];
        } else if (uploadType === "folder") {
          imageSources = [...document.getElementById("folderUpload").files];
        }

        if (uploadType !== "zip") {
          for (const file of imageSources) {
            if (/\.(jpg|jpeg|png)$/i.test(file.name)) {
              imageMap.set(file.name, URL.createObjectURL(file));
            }
          }
        }

        if (imageMap.size === 0) {
          Swal.fire("Error", "No valid image files were found.", "error");
          return;
        }

        const matchedData = excelData
          .map((row) => {
            if (imageMap.has(row.Attachment_Name)) {
              return { ...row, imageUrl: imageMap.get(row.Attachment_Name) };
            } else {
              unmatchedExcelRows.push(row.Attachment_Name);
              return null;
            }
          })
          .filter(Boolean);

        imageMap.forEach((_, imageName) => {
          if (!excelData.some((row) => row.Attachment_Name === imageName)) {
            unmatchedImages.push(imageName);
          }
        });

        generateReport(matchedData, projectName, siteLocation, projectNumber);

        document.getElementById("export-word").style.display = "block";
        document.getElementById("download-log").style.display = "block";
      }

      async function parseExcel(file) {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet);

        return jsonData.map((row) => {
          let convertedRow = { ...row };

          // **Fix Date/Time if it's a serial number**
          if (typeof row["EXIF_ImageDateTime_Text"] === "number") {
            convertedRow["EXIF_ImageDateTime_Text"] = excelDateToJSDate(
              row["EXIF_ImageDateTime_Text"]
            );
          }

          // **Ensure correct Photo Direction field is used**
          convertedRow["Photo Direction"] = row["Direction_Photo"] || "Unknown";

          return convertedRow;
        });
      }

      // Convert Excel date serial number to JavaScript Date
      function excelDateToJSDate(serial) {
        const utcDays = Math.floor(serial - 25569);
        const utcValue = utcDays * 86400; // Seconds
        const fractionalDay = serial - Math.floor(serial);
        const totalSeconds = Math.floor(fractionalDay * 86400);

        const date = new Date((utcValue + totalSeconds) * 1000); // Total milliseconds
        return date.toLocaleString(); // e.g., "12/4/2024, 10:44:00 AM"
      }

      function generateReport(data, projectName, siteLocation, projectNumber) {
        const reportContent = document.getElementById("report-content");
        reportContent.classList.remove("d-none");
        reportContent.innerHTML = `
          <h2 class="text-center">PHOTOGRAPH LOG</h2>
          <table class="table">
            <tr>
              <td><strong>Project Name:</strong> ${projectName}</td>
              <td><strong>Site Location:</strong> ${siteLocation}</td>
              <td><strong>Project No.:</strong> ${projectNumber}</td>
            </tr>
          </table>
        `;

        data.forEach((item, index) => {
          reportContent.innerHTML += `
            <table class="report-table">
              <tr>
                <td class="metadata-label"><strong>Date/Time Taken:</strong></td>
                <td class="metadata-value">${
                  item["EXIF_ImageDateTime_Text"] || "Unknown"
                }</td>
                <td rowspan="8" class="photo-container"><img src="${
                  item.imageUrl
                }" alt="Photo"></td>
              </tr>
              <tr class="striped-row">
                <td class="metadata-label"><strong>Photographer:</strong></td>
                <td class="metadata-value">${
                  item["Photographer"] || "Unknown"
                }</td>
              </tr>
              <tr>
                <td class="metadata-label"><strong>Latitude:</strong></td>
                <td class="metadata-value">${
                  item["FeatureLatitude"] || "Unknown"
                }</td>
              </tr>
              <tr class="striped-row">
                <td class="metadata-label"><strong>Longitude:</strong></td>
                <td class="metadata-value">${
                  item["FeatureLongitude"] || "Unknown"
                }</td>
              </tr>
              <tr>
                <td class="metadata-label"><strong>Photo Direction:</strong></td>
                <td class="metadata-value">${
                  item["Photo Direction"] || "Unknown"
                }</td>
              </tr>
              <tr class="striped-row">
                <td class="metadata-label"><strong>Category:</strong></td>
                <td class="metadata-value">${item["Category"] || "Unknown"}</td>
              </tr>
              <tr>
                <td class="metadata-label"><strong>Photo Description:</strong></td>
                <td class="metadata-value">${
                  item["Description"] || "No Description Provided"
                }</td>
              </tr>
              <tr class="striped-row">
                <td class="metadata-label"><strong>Photo Name:</strong></td>
                <td class="metadata-value">${
                  item["Attachment_Name"] || "Unknown"
                }</td>
              </tr>
            </table>
          `;
        });
        document.getElementById("export-word").style.display = "block";
        document.getElementById("download-log").style.display = "block";
      }

      function downloadLogFile() {
        if (unmatchedImages.length || unmatchedExcelRows.length) {
          Swal.fire(
            "Warning",
            "Some images or Excel entries were skipped. Check the log file.",
            "warning"
          );

          const logContent =
            `Photo Report Log - Generated on ${new Date().toISOString()}\n\n` +
            `Skipped Images (Not in Excel):\n${unmatchedImages.join(
              "\n"
            )}\n\n` +
            `Skipped Excel Rows (Missing Image):\n${unmatchedExcelRows.join(
              "\n"
            )}\n\nEnd of Log.`;

          // Console log the report log
          console.log("Photo Report Log:\n", logContent);

          // Create downloadable file
          const blob = new Blob([logContent], { type: "text/plain" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "photo_report_log.txt";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else {
          Swal.fire(
            "Info",
            "No unmatched images or Excel rows. Nothing to log.",
            "info"
          );
        }
      }

      function chooseTemplate() {
        Swal.fire({
          title: "Choose Report Template",
          input: "radio",
          inputOptions: {
            a: "Template A<br> (2 images per page)",
            b: "Template B<br>(1 image per page)",
          },
          inputValidator: (value) => {
            if (!value) return "Please select a template";
          },
        }).then((result) => {
          if (result.isConfirmed) {
            if (result.value === "a") exportTemplateA();
            else exportTemplateB();
          }
        });
      }

      async function exportTemplateA() {
        Swal.fire({
          title: "Generating Word Document...",
          text: "Please wait while we build your report.",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        const {
          Document,
          Packer,
          Paragraph,
          TextRun,
          ImageRun,
          Table,
          TableRow,
          TableCell,
          WidthType,
          BorderStyle,
          AlignmentType,
          VerticalAlign,
          ShadingType,
          Header,
          Footer,
          PageNumber,
          TableLayoutType,
          HeightRule,
        } = window.docx;

        const inchToDxa = (inches) => Math.floor(inches * 1440);

        const projectName =
          document.getElementById("projectName").value || "Unknown";
        const siteLocation =
          document.getElementById("siteLocation").value || "Unknown";
        const projectNumber =
          document.getElementById("projectNumber").value || "Unknown";

        const reportContent = document.getElementById("report-content");
        const tables = reportContent.querySelectorAll(".report-table");

        const children = [];

        const logoResponse = await fetch("tetra-tech-logo.png");
        const logoBuffer = await logoResponse.arrayBuffer();

        const epaLogoResponse = await fetch("epa-logo.png");
        const epaLogoBuffer = await epaLogoResponse.arrayBuffer();

        const header = new Header({
          children: [
            new Table({
              width: { size: 100, type: WidthType.PERCENTAGE },
              borders: {
                top: { style: BorderStyle.NONE },
                bottom: { style: BorderStyle.NONE },
                left: { style: BorderStyle.NONE },
                right: { style: BorderStyle.NONE },
                insideHorizontal: { style: BorderStyle.NONE },
                insideVertical: { style: BorderStyle.NONE },
              },
              rows: [
                new TableRow({
                  children: [
                    new TableCell({
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.LEFT,
                          children: [
                            new ImageRun({
                              data: logoBuffer,
                              transformation: {
                                width: 100,
                                height: Math.round(100 / 3.76),
                              }, // height â‰ˆ 27
                              type: "png",
                            }),
                          ],
                        }),
                      ],
                    }),
                    new TableCell({
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.CENTER,
                          children: [
                            new TextRun({
                              text: "PHOTOGRAPH LOG",
                              bold: true,
                              font: "Arial",
                              size: 28,
                            }),
                          ],
                        }),
                      ],
                    }),
                    new TableCell({
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.RIGHT,
                          children: [
                            new ImageRun({
                              data: epaLogoBuffer,
                              transformation: {
                                width: 80,
                                height: Math.round(80 / 3.29),
                              }, // â‰ˆ 24
                              type: "png",
                            }),
                          ],
                        }),
                      ],
                    }),
                  ],
                }),
              ],
            }),
            new Table({
              width: { size: 100, type: WidthType.PERCENTAGE },
              borders: {
                top: { style: BorderStyle.SINGLE, size: 6, color: "000000" },
                bottom: { style: BorderStyle.SINGLE, size: 6, color: "000000" },
                left: { style: BorderStyle.NONE },
                right: { style: BorderStyle.NONE },
                insideHorizontal: { style: BorderStyle.NONE },
                insideVertical: { style: BorderStyle.NONE },
              },
              rows: [
                new TableRow({
                  children: [
                    new TableCell({
                      borders: {
                        top: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                        bottom: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                      },
                      margins: { top: 100, bottom: 100 }, // ðŸ†• Adds ~0.07" padding
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.LEFT,
                          children: [
                            new TextRun({
                              text: "Project Name:",
                              bold: true,
                              underline: {},
                              font: "Arial",
                            }),
                            new TextRun({ break: 1 }),
                            new TextRun({ text: projectName, font: "Arial" }),
                          ],
                        }),
                      ],
                    }),
                    new TableCell({
                      borders: {
                        top: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                        bottom: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                      },
                      margins: { top: 100, bottom: 100 }, // ðŸ†• Adds ~0.07" padding
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.CENTER,
                          children: [
                            new TextRun({
                              text: "Site Location:",
                              bold: true,
                              underline: {},
                              font: "Arial",
                            }),
                            new TextRun({ break: 1 }),
                            new TextRun({ text: siteLocation, font: "Arial" }),
                          ],
                        }),
                      ],
                    }),
                    new TableCell({
                      borders: {
                        top: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                        bottom: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                      },
                      margins: { top: 100, bottom: 100 }, // ðŸ†• Adds ~0.07" padding
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.RIGHT,
                          children: [
                            new TextRun({
                              text: "Project Number:",
                              bold: true,
                              underline: {},
                              font: "Arial",
                            }),
                            new TextRun({ break: 1 }),
                            new TextRun({ text: projectNumber, font: "Arial" }),
                          ],
                        }),
                      ],
                    }),
                  ],
                }),
              ],
            }),
          ],
        });

        const footer = new Footer({
          children: [
            new Paragraph({
              alignment: AlignmentType.CENTER,
              children: [
                new TextRun({ text: "Page ", font: "Arial", bold: true }),
                new TextRun({
                  children: [PageNumber.CURRENT],
                  font: "Arial",
                  bold: true,
                }),
                new TextRun({ text: " of ", font: "Arial", bold: true }),
                new TextRun({
                  children: [PageNumber.TOTAL_PAGES],
                  font: "Arial",
                  bold: true,
                }),
              ],
            }),
          ],
        });

        for (let i = 0; i < tables.length; i++) {
          const table = tables[i];
          const rows = table.querySelectorAll("tr");
          const imgTag = table.querySelector("img");

          const metadata = Array.from(rows)
            .map((row) => {
              const cells = row.querySelectorAll("td");
              return cells.length >= 2
                ? {
                    label: cells[0].innerText.trim(),
                    value: cells[1].innerText.trim(),
                  }
                : null;
            })
            .filter(Boolean);

          let imageCell;

          if (imgTag?.src) {
            try {
              const tempImg = new Image();
              tempImg.crossOrigin = "anonymous";
              tempImg.src = imgTag.src;
              await new Promise((resolve) => (tempImg.onload = resolve));

              const canvas = document.createElement("canvas");
              canvas.width = tempImg.naturalWidth;
              canvas.height = tempImg.naturalHeight;
              canvas.getContext("2d").drawImage(tempImg, 0, 0);

              const blob = await new Promise((resolve) =>
                canvas.toBlob((b) => {
                  if (!b) {
                    console.warn(
                      "â— Image blob generation failed for",
                      imgTag.src
                    );
                    resolve(null);
                  } else {
                    resolve(b);
                  }
                }, "image/png")
              );

              if (!blob) continue;

              const buffer = await blob.arrayBuffer();

              const maxPortraitHeight = 4.5 * 96;
              const maxLandscapeWidth = 5.1 * 96; // ~7.3 inches = 7008 DXA
              const isPortrait = tempImg.naturalHeight > tempImg.naturalWidth;

              let scale;
              if (isPortrait) {
                scale = Math.min(1, maxPortraitHeight / tempImg.naturalHeight);
              } else {
                scale = Math.min(1, maxLandscapeWidth / tempImg.naturalWidth);
              }

              const scaledWidth = Math.round(tempImg.naturalWidth * scale);
              const scaledHeight = Math.round(tempImg.naturalHeight * scale);

              imageCell = new TableCell({
                verticalAlign: VerticalAlign.CENTER,
                width: { size: 7200, type: WidthType.DXA },
                ...(metadata.length > 1 ? { rowSpan: metadata.length } : {}),
                children: [
                  new Paragraph({
                    alignment: AlignmentType.CENTER,
                    children: [
                      new ImageRun({
                        data: buffer,
                        transformation: {
                          width: scaledWidth,
                          height: scaledHeight,
                        },
                        type: "png",
                      }),
                    ],
                  }),
                ],
              });
            } catch (err) {
              console.error("âŒ Failed to render image:", err);
              continue;
            }
          }

          const wordRows = metadata.map((meta, index) => {
            const shaded = index % 2 === 0;

            if (meta.label === "Photo Description:") {
              return new TableRow({
                height: { value: inchToDxa(2), rule: HeightRule.AT_LEAST },
                children: [
                  new TableCell({
                    columnSpan: 2,
                    width: { size: 3312, type: WidthType.DXA },
                    verticalAlign: VerticalAlign.TOP,
                    margins: { top: 72, bottom: 72, left: 72, right: 72 },
                    shading: shaded
                      ? {
                          fill: "F2F2F2",
                          type: ShadingType.CLEAR,
                          color: "auto",
                        }
                      : undefined,
                    children: [
                      new Paragraph({
                        alignment: AlignmentType.LEFT,
                        children: [
                          new TextRun({
                            text: meta.label,
                            bold: true,
                            font: "Arial",
                          }),
                          new TextRun({ break: 1 }),
                          new TextRun({
                            text: meta.value || "No Description Provided",
                            font: "Arial",
                          }),
                        ],
                      }),
                    ],
                  }),
                  ...(index === 0 && imageCell ? [imageCell] : []),
                ],
              });
            }

            if (meta.label === "Photo Name:") {
              return new TableRow({
                height: { value: inchToDxa(0.4), rule: HeightRule.AT_LEAST },
                children: [
                  new TableCell({
                    columnSpan: 2,
                    width: { size: 3312, type: WidthType.DXA },
                    verticalAlign: VerticalAlign.CENTER,
                    margins: { bottom: 24, left: 72, right: 72 },
                    children: [
                      new Paragraph({
                        alignment: AlignmentType.LEFT,
                        children: [
                          new TextRun({
                            text: meta.label,
                            bold: true,
                            font: "Arial",
                          }),
                          new TextRun({
                            text: meta.value || "Unknown",
                            font: "Arial",
                            break: 1,
                          }),
                        ],
                      }),
                    ],
                  }),
                  ...(index === 0 ? [imageCell] : []),
                ],
              });
            }

            const baseCells = [
              new TableCell({
                width: { size: 1656, type: WidthType.DXA },
                verticalAlign: VerticalAlign.CENTER,
                margins: { left: 72, right: 72 },
                shading: shaded
                  ? { fill: "F2F2F2", type: ShadingType.CLEAR, color: "auto" }
                  : undefined,
                children: [
                  new Paragraph({
                    alignment: AlignmentType.LEFT,
                    children: [
                      new TextRun({
                        text: meta.label,
                        bold: true,
                        font: "Arial",
                      }),
                    ],
                  }),
                ],
              }),
              new TableCell({
                width: { size: 1656, type: WidthType.DXA },
                verticalAlign: VerticalAlign.CENTER,
                margins: { left: 72, right: 72 },
                shading: shaded
                  ? { fill: "F2F2F2", type: ShadingType.CLEAR, color: "auto" }
                  : undefined,
                children: [
                  new Paragraph({
                    alignment: AlignmentType.LEFT,
                    children: [
                      new TextRun({
                        text: meta.value || "Unknown",
                        font: "Arial",
                      }),
                    ],
                  }),
                ],
              }),
            ];

            if (index === 0) baseCells.push(imageCell);

            return new TableRow({
              height: { value: inchToDxa(0.34), rule: HeightRule.AT_LEAST },
              children: baseCells,
            });
          });

          children.push(
            new Table({
              rows: wordRows,
              width: { size: 10912, type: WidthType.DXA },
              columnWidths: [1656, 1656, 7600],
              layout: TableLayoutType.FIXED,
            }),
            new Paragraph({ children: [new TextRun({ text: "", size: 1 })] })
          );

          if ((i + 1) % 2 === 0 && i !== tables.length - 1) {
            children.push(
              new Paragraph({
                children: [new TextRun({ text: "", size: 1 })],
                pageBreakBefore: true,
              })
            );
          }
        }

        const fileName = `Photo_Report_${
          new Date().toISOString().split("T")[0]
        }.docx`;

        const doc = new Document({
          creator: "Photolog Tool",
          title: fileName,
          description: "Photo report generated by web-based photolog tool",
          sections: [
            {
              properties: {
                page: {
                  margin: { top: 475, right: 475, bottom: 475, left: 475 },
                  borders: {
                    top: {
                      style: BorderStyle.SINGLE,
                      size: 8,
                      color: "000000",
                      space: 24,
                    },
                    bottom: {
                      style: BorderStyle.SINGLE,
                      size: 8,
                      color: "000000",
                      space: 24,
                    },
                    left: {
                      style: BorderStyle.SINGLE,
                      size: 8,
                      color: "000000",
                      space: 24,
                    },
                    right: {
                      style: BorderStyle.SINGLE,
                      size: 8,
                      color: "000000",
                      space: 24,
                    },
                    display: docx.PageBorderDisplay.ALL_PAGES,
                    zOrder: docx.PageBorderZOrder.FRONT,
                  },
                },
              },
              headers: { default: header },
              footers: { default: footer },
              children: [
                new Paragraph({
                  spacing: { after: 60 },
                  children: [new TextRun({ text: "", size: 1 })],
                }),
                ...children,
              ],
            },
          ],
        });

        const blob = await Packer.toBlob(doc);
        Swal.close();
        saveAs(blob, fileName);
      }

      async function exportTemplateB() {
        Swal.fire({
          title: "Generating Word Document (Template B)...",
          text: "Please wait while we build your report.",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        const {
          Document,
          Packer,
          Paragraph,
          ImageRun,
          TextRun,
          Table,
          TableRow,
          TableCell,
          WidthType,
          BorderStyle,
          AlignmentType,
          VerticalAlign,
          ShadingType,
          Header,
          Footer,
          PageNumber,
          TableLayoutType,
          HeightRule,
        } = window.docx;

        const inchToDxa = (inches) => Math.floor(inches * 1440);

        const projectName =
          document.getElementById("projectName")?.value?.trim() || "Unknown";
        const siteLocation =
          document.getElementById("siteLocation")?.value?.trim() || "Unknown";
        const projectNumber =
          document.getElementById("projectNumber")?.value?.trim() || "Unknown";

        const reportContent = document.getElementById("report-content");
        const tables = reportContent.querySelectorAll(".report-table");

        const children = [];

        const logoResponse = await fetch("tetra-tech-logo.png");
        const logoBuffer = await logoResponse.arrayBuffer();
        const epaLogoResponse = await fetch("epa-logo.png");
        const epaLogoBuffer = await epaLogoResponse.arrayBuffer();

        const header = new Header({
          children: [
            new Table({
              width: { size: 100, type: WidthType.PERCENTAGE },
              borders: {
                top: { style: BorderStyle.NONE },
                bottom: { style: BorderStyle.NONE },
                left: { style: BorderStyle.NONE },
                right: { style: BorderStyle.NONE },
                insideHorizontal: { style: BorderStyle.NONE },
                insideVertical: { style: BorderStyle.NONE },
              },
              rows: [
                new TableRow({
                  children: [
                    new TableCell({
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.LEFT,
                          children: [
                            new ImageRun({
                              data: logoBuffer,
                              transformation: { width: 92, height: 24 }, // height â‰ˆ 27
                              type: "png",
                            }),
                          ],
                        }),
                      ],
                    }),
                    new TableCell({
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.CENTER,
                          children: [
                            new TextRun({
                              text: "PHOTOGRAPH LOG",
                              bold: true,
                              font: "Arial",
                              size: 28,
                            }),
                          ],
                        }),
                      ],
                    }),
                    new TableCell({
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.RIGHT,
                          children: [
                            new ImageRun({
                              data: epaLogoBuffer,
                              transformation: { width: 80, height: 24 }, // â‰ˆ 24
                              type: "png",
                            }),
                          ],
                        }),
                      ],
                    }),
                  ],
                }),
              ],
            }),
            new Table({
              width: { size: 100, type: WidthType.PERCENTAGE },
              borders: {
                top: { style: BorderStyle.SINGLE, size: 6, color: "000000" },
                bottom: { style: BorderStyle.SINGLE, size: 6, color: "000000" },
                left: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" },
                right: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" },
                insideHorizontal: {
                  style: BorderStyle.NONE,
                  size: 0,
                  color: "FFFFFF",
                },
                insideVertical: {
                  style: BorderStyle.NONE,
                  size: 0,
                  color: "FFFFFF",
                },
              },
              rows: [
                new TableRow({
                  children: [
                    new TableCell({
                      borders: {
                        top: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                        bottom: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                        left: { style: BorderStyle.NONE },
                        right: { style: BorderStyle.NONE },
                      },
                      margins: { top: 100, bottom: 100 }, // ðŸ”½ Adds vertical padding (~0.07")
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.LEFT,
                          children: [
                            new TextRun({
                              text: "Project Name: ",
                              bold: true,
                              underline: {},
                              font: "Arial",
                            }),
                            new TextRun({ break: 1 }),
                            new TextRun({ text: projectName, font: "Arial" }),
                          ],
                        }),
                      ],
                    }),
                    new TableCell({
                      borders: {
                        top: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                        bottom: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                        left: { style: BorderStyle.NONE },
                        right: { style: BorderStyle.NONE },
                      },
                      margins: { top: 100, bottom: 100 }, // ðŸ”½ Adds vertical padding (~0.07")
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.CENTER,
                          children: [
                            new TextRun({
                              text: "Site Location: ",
                              bold: true,
                              underline: {},
                              font: "Arial",
                            }),
                            new TextRun({ break: 1 }),
                            new TextRun({ text: siteLocation, font: "Arial" }),
                          ],
                        }),
                      ],
                    }),
                    new TableCell({
                      borders: {
                        top: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                        bottom: {
                          style: BorderStyle.SINGLE,
                          size: 6,
                          color: "000000",
                        },
                        left: { style: BorderStyle.NONE },
                        right: { style: BorderStyle.NONE },
                      },
                      margins: { top: 100, bottom: 100 }, // ðŸ”½ Adds vertical padding (~0.07")
                      children: [
                        new Paragraph({
                          alignment: AlignmentType.RIGHT,
                          children: [
                            new TextRun({
                              text: "Project Number: ",
                              bold: true,
                              underline: {},
                              font: "Arial",
                            }),
                            new TextRun({ break: 1 }),
                            new TextRun({ text: projectNumber, font: "Arial" }),
                          ],
                        }),
                      ],
                    }),
                  ],
                }),
              ],
            }),
          ],
        });

        const footer = new Footer({
          children: [
            new Paragraph({
              alignment: AlignmentType.CENTER,
              children: [
                new TextRun({ text: "Page ", font: "Arial", bold: true }),
                new TextRun({
                  children: [PageNumber.CURRENT],
                  font: "Arial",
                  bold: true,
                }),
                new TextRun({ text: " of ", font: "Arial", bold: true }),
                new TextRun({
                  children: [PageNumber.TOTAL_PAGES],
                  font: "Arial",
                  bold: true,
                }),
              ],
            }),
          ],
        });

        for (let i = 0; i < tables.length; i++) {
          const table = tables[i];
          const rows = table.querySelectorAll("tr");
          const imgTag = table.querySelector("img");

          const metadata = {};
          rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            if (cells.length >= 2) {
              const label = cells[0].innerText.trim().replace(":", "");
              const value = cells[1].innerText.trim();
              metadata[label] = value;
            }
          });

          let imageRow = new TableRow({
            children: [
              new TableCell({
                columnSpan: 3,
                verticalAlign: VerticalAlign.CENTER,
                children: [],
              }),
            ],
          });

          if (imgTag?.src) {
            const tempImg = new Image();
            tempImg.crossOrigin = "anonymous";
            tempImg.src = imgTag.src;
            await new Promise((resolve) => (tempImg.onload = resolve));

            const canvas = document.createElement("canvas");
            canvas.width = tempImg.naturalWidth;
            canvas.height = tempImg.naturalHeight;
            canvas.getContext("2d").drawImage(tempImg, 0, 0);

            const blob = await new Promise((resolve) =>
              canvas.toBlob(resolve, "image/png")
            );
            const buffer = await blob.arrayBuffer();

            const DPI = 96;
            const MAX_HEIGHT = 3.94 * DPI;
            const MAX_WIDTH = 7.58 * DPI;

            const isPortrait = tempImg.naturalHeight > tempImg.naturalWidth;
            const scale = isPortrait
              ? (8.5 * DPI) / tempImg.naturalHeight // scale to full cell height
              : Math.min(1, MAX_WIDTH / tempImg.naturalWidth); // landscape stays width-limited

            const scaledWidth = Math.round(tempImg.naturalWidth * scale);
            const scaledHeight = Math.round(tempImg.naturalHeight * scale);

            imageRow = new TableRow({
              height: {
                value: inchToDxa(8.5), // ðŸ”º 7 inches tall
                rule: HeightRule.EXACT,
              },
              children: [
                new TableCell({
                  columnSpan: 3,
                  verticalAlign: VerticalAlign.CENTER,
                  children: [
                    new Paragraph({
                      alignment: AlignmentType.CENTER,
                      children: [
                        new ImageRun({
                          data: buffer,
                          transformation: {
                            width: scaledWidth,
                            height: scaledHeight,
                          },
                          type: "png",
                        }),
                      ],
                    }),
                  ],
                }),
              ],
            });
          }

          const metaRows = [
            imageRow,
            new TableRow({
              children: [
                new TableCell({
                  columnSpan: 3,
                  margins: { top: 72, bottom: 72, left: 72, right: 72 },
                  children: [
                    new Paragraph({
                      alignment: AlignmentType.LEFT,
                      children: [
                        new TextRun({
                          text: "Photo Description: ",
                          bold: true,
                          font: "Arial",
                        }),
                        new TextRun({ break: 1 }),
                        new TextRun({
                          text:
                            metadata["Photo Description"] || "No Description",
                          font: "Arial",
                        }),
                      ],
                    }),
                  ],
                }),
              ],
            }),
            new TableRow({
              children: ["Date/Time Taken", "Photographer", "Category"].map(
                (label) =>
                  new TableCell({
                    margins: { top: 72, bottom: 72, left: 72, right: 72 },
                    children: [
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: `${label}: `,
                            bold: true,
                            font: "Arial",
                          }),
                          new TextRun({
                            text: metadata[label] || "Unknown",
                            font: "Arial",
                          }),
                        ],
                      }),
                    ],
                  })
              ),
            }),
            new TableRow({
              children: ["Latitude", "Longitude", "Photo Direction"].map(
                (label) =>
                  new TableCell({
                    margins: { top: 72, bottom: 72, left: 72, right: 72 },
                    children: [
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: `${label}: `,
                            bold: true,
                            font: "Arial",
                          }),
                          new TextRun({
                            text: metadata[label] || "Unknown",
                            font: "Arial",
                          }),
                        ],
                      }),
                    ],
                  })
              ),
            }),
          ];

          children.push(
            new Paragraph({ pageBreakBefore: i !== 0, children: [] }),
            new Table({
              width: { size: 10912, type: WidthType.DXA },
              columnWidths: [3637, 3637, 3637],
              rows: metaRows,
              layout: TableLayoutType.FIXED,
            })
          );
        }

        const fileName = `Photo_Report_TemplateB_${
          new Date().toISOString().split("T")[0]
        }.docx`;

        const doc = new Document({
          creator: "Photolog Tool",
          title: fileName, // Optional: match filename
          description: "Photo report generated by web-based photolog tool",
          sections: [
            {
              headers: { default: header },
              footers: { default: footer },
              properties: {
                page: {
                  margin: { top: 475, bottom: 475, left: 475, right: 475 },
                },
              },
              children,
            },
          ],
        });

        const blob = await Packer.toBlob(doc);

        Swal.close();
        saveAs(blob, fileName);
      }
    </script>
  </body>
</html>
